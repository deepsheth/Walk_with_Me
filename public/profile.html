<head>
	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<!-- Firebase -->
	<script src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
	<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyBn3v_1yzu_bEKpxBUCPKtQVJngCYoamgE",
		authDomain: "walk-with-me-2f1f5.firebaseapp.com",
		databaseURL: "https://walk-with-me-2f1f5.firebaseio.com",
		storageBucket: "walk-with-me-2f1f5.appspot.com",
		messagingSenderId: "306025142010"
	};
	firebase.initializeApp(config);
	</script>
	<!-- GeoFire -->
	<script src="https://cdn.firebase.com/libs/geofire/4.1.2/geofire.min.js"></script>
	<!--Import Google Icon Font-->
	<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	
	<!-- CSS -->
	<!-- Compiled and minified CSS -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/css?family=Fredoka+One|Montserrat:400,700" rel="stylesheet">
	<link rel="stylesheet" href="/css/style.css">
	<!-- JS -->
	<!-- Compiled and minified JavaScript -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="/js/WWM-toolkit.js"></script>
	<script type="text/javascript" src="/js/script.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBn3v_1yzu_bEKpxBUCPKtQVJngCYoamgE&callback=initMiniMap"
	async defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<html>
	<nav>
		<div class="nav-wrapper">
			<a href="/app.html" class="brand-logo">Walk with Me</a>
			<ul class="right hide-on-med-and-down">
				<li><a href="profile.html">Past Walks</a></li>
				<li><a id="btn_log_out">Log Out</a></li>
			</ul>
			<ul id="slide-out" class="side-nav">
				<li><div class="userView">
					<div class="background">
						<img src="http://cdn-7.nikon-cdn.com/Images/Learn-Explore/Photography-Techniques/2012/Bokeh-for-Beginners/Media/Bokeh-1-JodyDole-1.jpg">
					</div>
					<a href="#!user"><img class="circle" src="https://avatars3.githubusercontent.com/u/8071305"></a>
					<a href="#!name"><span class="white-text name">Deep Sheth</span></a>
					<a href="#!email"><span class="white-text email">deepsheth@lehigh.com</span></a>
				</div></li>
				<li><a href="profile.html"><i class="material-icons">history</i>Past Walks</a></li>
				<li><a href="login.html"><i class="material-icons">account_circle</i>Log In</a></li>
				<li><div class="divider"></div></li>
				<li><a href="!#"><i class="material-icons"></i>Log Out</a></li>
			</ul>
			<a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
		</div>
	</nav>
	<div id="personal_info">
		<div class="container">
			<div class="row">
				<div id="user_picture" class="col s6"><div id="user-profile-picture-image"></div><i id="edit-profile-picture" class="material-icons" style="color:white;">mode_edit</i></div>
				<div id="name_walks_wrapper" class="col s6">
					<input value="" id="user_name_field" type="text" class="validate" style="display:none;">
					<label id="user_name_label" class="active" for="user_name_field" style="display:none;">Enter Name...</label><div id="user_name"><i id="edit-name" class="material-icons">mode_edit</i></div>
					<div id="user_walks" class="blue-grey-text"></div>
				</div>
			</div>
		</div>
	</div>
	<div id="past_walks">
		<div class="container">
			<div id="past_walks_title"><div class="section"><h3>Past Walks</h3></div></div>
			<div class="row">
				<div class="col s6">
					<div id="mini-map" >
						map goes here
					</div>
				</div>
				<div id="list" class="col s6 grey lighten-4">
					<div id="walk-cards-title" class="row center grey-text grey lighten-3">
						<span id="walked-with" class="col s4">walked with</span><span id="walked-to" class="col s4">to</span><span id="walked-date" class="col s4">on</span>
					</div>
					<!--<div id="walk-card" class="row hoverable">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row hoverable">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row hoverable">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row hoverable">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>
					<div id="walk-card" class="row">
							<div id="walk-info">
									<span class="walk-partner col s4"><span class="walk-partner-image"><image src="https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2FKohFVT0scPa5CNGXGM5cDnedHdr2?alt=media&token=09e17761-9414-4eb9-857d-fc0661dca57f"></span><span class="walk-partner-name">Adam</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">Rauch</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">Dec 2nd</span>
							</div>
					</div>-->
				</div>
			</div>
		</div>
		<input id="pro-pic-upload" type="file" style="display:none;">
	</div>
	<script>
	firebase.auth().onAuthStateChanged(function(user) {
		
		if (user) {
			var user = firebase.auth().currentUser;
			var userID = user.uid;
			console.log(userID);
		
			var reference = firebase.database().ref("users/" + userID);
			console.log(reference);
			reference.once('value').then(function(snapshot){
				var name = snapshot.val().name;
				var numWalks = snapshot.val().number_of_walks;
				$('#user_name').html(name+'<i id="edit-name" class="material-icons">mode_edit</i>');
				$('#user_name_field').attr('value',name);
				$('#user_walks').html(numWalks+" walks");
			}, function(error) {
				console.log(error.message);
			});
			var storage = firebase.storage();
			var storageRef = storage.ref();
			//create reference to the location in the database
			var imagesRef = storageRef.child('profile_pictures');
			// Get the user id to use as the unique filename for their profile picture
			var uploadRef = imagesRef.child(userID+'.png');
			//pull the image url, and for example I put it into the display_pro_pic div
			uploadRef.getDownloadURL().then(function(url){
				console.log(url);
				$('#user-profile-picture-image').css('background-image', 'url(' + url + ')');
			}).catch(function(error) {
				console.log("User has not uploaded image yet.");
			});
			$('#user_name').click(function(){
				$('#user_name').hide();
				$('#user_name_field').show();
				$('#user_name_label').show();
			});
			$("#user_name_field").keypress(function(event) {
			if (event.which == 13 && $('#user_name_field').val() != '' && $('#user_name_field').val().length > 3) {
				var newName = $('#user_name_field').val();
			firebase.database().ref('users/'+user.uid+'/name').set(newName);
			$('#user_name').html(newName+'<i id="edit-name" class="material-icons">mode_edit</i>');
			$('#user_name').show();
					$('#user_name_field').hide();
					$('#user_name_label').hide();
			}
			});
			$(document).keyup(function(event){
				if (event.keyCode === 27){
					$('#user_name').show();
					$('#user_name_field').hide();
					$('#user_name_label').hide();
				}
			});
			var locations = [];
			var walkHistoryRef = firebase.database().ref('walk_history/'+user.uid);
			walkHistoryRef.on('child_added',function(snapshot){
				console.log(snapshot.getKey());
				get_walk_data(snapshot.getKey(),'past',user,function(walkData){
					console.log(walkData);
					var date = new Date(walkData['time']);
					var date_string = date.toString()
					var date_string = date_string.substring(4,10);
					console.log(walkData);
					locations.push({
						'start_latitude': walkData['start_latitude'],
						'start_longitude': walkData['start_longitude'],
						'end_latitude': walkData['end_latitude'],
						'end_longitude': walkData['end_longitude']
					});
					// if (typeof walkData[responder_image] === 'undefined') {
					//     // variable is undefined
					// }
					if (walkData["responder_image"] == null) {
						walkData["responder_image"] = "https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2Fdefault-user-image.png?alt=media&token=63589b69-e115-43e5-9248-562eb2f7de2c";
					}
					var curr_list_item, mkr1, mkr2;
					if (walkData['responder_id'] == user.uid){
						$('#list').append('<div id="walk-card" class="row hoverable"><div id="walk-info"><span class="walk-partner col s2"><span class="walk-partner-image"><image class="tooltipped" data-position="left" data-tooltip="'+walkData['poster_name']+'" src="'+walkData['poster_image']+'"></span><span class="walk-partner-name">'+walkData['poster_name']+'</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s5">'+walkData['destination_name']+'</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">'+date_string+'</span></div></div>');
						curr_list_item = $('#list .row:last');
						curr_list_item.on('mouseenter', function() {
							mkr1 = addHoverMarkerStart(walkData["start_latitude"], walkData["start_longitude"], "start");
							mkr2 = addHoverMarkerStart(walkData["start_latitude"], walkData["end_longitude"], "end");
						});
						curr_list_item.on('mouseleave', function() {
							mkr1.setMap(null);
							mkr2.setMap(null);
						});
					}
					else{
						$('#list').append('<div id="walk-card" class="row hoverable"><div id="walk-info"><span class="walk-partner col s4"><span class="walk-partner-image"><image class="tooltipped" data-position="left" data-tooltip="'+walkData['responder_name']+'" src="'+walkData['responder_image']+'"></span><span class="walk-partner-name">'+walkData['responder_name']+'</span></span><span class="walk-info-small col s1">to</span><span class="walk-destination col s3">'+walkData['destination_name']+'</span><span class="walk-info-small col s1">on</span><span class="walk-date col s3">'+date_string+'</span></div></div>');
						curr_list_item = $('#list .row:last');
						curr_list_item.on('mouseenter', function() {
							mkr1 = addHoverMarkerStart(walkData["start_latitude"], walkData["start_longitude"], "start");
							mkr2 = addHoverMarkerStart(walkData["start_latitude"], walkData["end_longitude"], "end");
						});
						curr_list_item.on('mouseleave', function() {
							mkr1.setMap(null);
							mkr2.setMap(null);
						});
					}
					$('.tooltipped').tooltip({delay: 0});
				});
			});
		}
	});
	$('#user_picture img').click(function(){
		console.log('clicked user pic');
		
		$('#pro-pic-upload').click();
	});
	$('#pro-pic-upload').change(function() {
		var storage = firebase.storage();
		var storageRef = storage.ref();
		//create reference to the location in the database
		var imagesRef = storageRef.child('profile_pictures');
		var selectedFile = $('#pro-pic-upload').get(0).files[0];
		// Get the user id to use as the unique filename for their profile picture
		var userID = firebase.auth().currentUser.uid;
		var uploadRef = imagesRef.child(userID+'.png');
		uploadRef.put(selectedFile).then(function(snapshot) {
			console.log('Profile Picture Uploaded');
		});
		$('#user-profile-picture-image').css('background-image', 'url(https://firebasestorage.googleapis.com/v0/b/walk-with-me-2f1f5.appspot.com/o/profile_pictures%2Fdefault-user-image.png?alt=media&token=63589b69-e115-43e5-9248-562eb2f7de2c)');
		setTimeout(function(){
			var uploadRef = imagesRef.child(userID+'.png');
			uploadRef.getDownloadURL().then(function(url){
			console.log(url);
			$('#user-profile-picture-image').css('background-image', 'url(' + url + ')');
			});
		}, 500);
	});
	
	</script>
</div>
</html>